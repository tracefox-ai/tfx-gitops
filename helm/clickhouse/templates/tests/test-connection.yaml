---
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "clickhouse.fullname" . }}-test-connection"
  namespace: {{ include "clickhouse.namespace" . }}
  labels:
    {{- include "clickhouse.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: clickhouse-client
      image: clickhouse/clickhouse-client:{{ .Values.clickhouse.image.tag }}
      command:
        - clickhouse-client
        - --host
        - >-
          chi-{{ .Values.clickhouse.name }}-{{ .Values.clickhouse.cluster.name }}-0-0
        - --port
        - "9000"
        - --user
        - {{ .Values.clickhouse.users.admin.username }}
        - --password
        - "$(CLICKHOUSE_PASSWORD)"
        - --query
        - "SELECT 1 as test_result"
      env:
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "clickhouse.adminSecretName" . }}
              key: {{ include "clickhouse.adminSecretKey" . }}
  restartPolicy: Never
